<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSS Links -->
    <link rel="stylesheet" href="../css/general/reset.css">
    <link rel="stylesheet" href="../css/pages/admin.css">
    <link rel="stylesheet" href="../css/response/adminResp.css">
    <!-- Fav icons -->
    <link rel="shortcut icon" href="../assets/fav-icon/android-chrome-192x192.png" type="image/x-icon">
    <link rel="shortcut icon" href="../assets/fav-icon/android-chrome-512x512.png" type="image/x-icon">
    <link rel="shortcut icon" href="../assets/fav-icon/apple-touch-icon.png" type="image/x-icon">
    <link rel="shortcut icon" href="../assets/fav-icon/favicon-16x16.png" type="image/x-icon">
    <link rel="shortcut icon" href="../assets/fav-icon/favicon-32x32.png" type="image/x-icon">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <title>Admin Dashboard</title>
</head>

<body>
    <!-- Admin Login Start -->
    <div class="admin-login">
        <div class="admin-logo">
            <img src="../assets/icons/adminlogo.svg" alt="">
        </div>
        <div class="login-page">
            <div class="form">
                <h1>Welcome Admin</h1>
                <form class="login-form">
                    <input class="login-user" type="text" placeholder="Username" />
                    <input class="login-password" type="password" placeholder="Password" />
                </form>
                <button class="adminJoin">Join</button>
            </div>
        </div>
    </div>
    <!-- Admin Login End -->

    <!-- Admin Panel Start -->
    <main>
        <!-- Side Bar -->
        <div class="panel">
            <div class="side-bar" id="sidebar">
                <ul class="menu">
                    <img class="logo" src="../assets/icons/adminlogo.svg" alt="Logo">
                    <li> <img src="../assets/icons/group.svg" alt=""> <a href="#home">Home</a></li>
                    <li> <img src="../assets/icons/group.svg" alt=""> <a href="#books">Books</a></li>
                    <li> <img src="../assets/icons/group.svg" alt=""> <a href="#about">About</a></li>
                    <li> <img src="../assets/icons/group.svg" alt=""> <a href="#join">Join Us</a></li>
                    <li> <img src="../assets/icons/group.svg" alt=""> <a href="#contact">Contact</a></li>
                    <li> <img src="../assets/icons/group.svg" alt=""> <a href="#logout">Logout</a></li>
                </ul>
            </div>

            <div class="dashboard" id="dashboard">
                <!-- Mobile Header -->
                <div class="mobile-header">
                    <div class="mobile-logo">
                        <img src="../assets/icons/navLogo.svg" alt="">
                    </div>
                    <div class="burger-menu" id="burgerMenu">
                        <img class="open" src="../assets/icons/bars.svg" alt="Burger Menu">
                    </div>
                    <div class="burger-close">
                        <img class="close" src="../assets/icons/close.svg" alt="Close Menu">
                    </div>
                </div>

                <div class="header">
                    <img src="../assets/icons/profile.svg" alt="">
                    <span class="admin-text">Admin</span>
                </div>

                <!-- Search Book-->
                <div class="content" id="home">
                    <h2>Add Book</h2>
                    <h3>Search Book</h3>
                    <div class="search-area">
                        <input type="text" placeholder="Search..." class="search-input">
                        <button class="src-btn"><img src="../assets/icons/lupa.svg" alt=""></button>
                    </div>
                    <div class="history">

                    </div>
                </div>

                <!-- Book Form -->
                <div class="book-form" id="bookForm">
                    <h2>Book Form</h2>
                    <div class="form-container">
                        <form autocomplete="off">
                            <label for="townborn">Book Name</label>
                            <input class="bookName" type="text" placeholder="Angels">

                            <label for="name">Author Name</label>
                            <input class="authorName" type="text" placeholder="Dan Brown">

                            <label for="name">Book Realiese Date</label>
                            <input class="bookDate" type="text" placeholder="1945">

                            <label for="townborn">Book Image Url</label>
                            <input class="bookImage" type="text" placeholder="URL">

                            <label for="text">Description</label>
                            <input class="bookDesc" type="text" placeholder="Lorem Ipsum Dolor Eldostun Maceralari">

                            <label for="townborn">Book Type</label>
                            <input class="bookType" type="text" placeholder="Dedective">

                            <label for="townborn">Book Category</label>
                            <select class="bookCategory" id="bookCat">
                                <option value="All books">All Books</option>
                                <option value="Best Seller">Best Seller</option>
                                <option value="New Realiese">New Realiese</option>
                            </select>
                        </form>
                        <button class="formBtn inpBtn" type="submit">Add</button>
                    </div>
                </div>


                <!-- Modal -->
                <div id="myModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <p id="modalMessage"></p>
                    </div>
                </div>

                <!-- About Store -->
                <div class="about-store" id="aboutStore">
                    <h2 id="about">About Store</h2>
                    <div class="form-container">
                        <form autocomplete="off">
                            <label for="townborn">Title</label>
                            <input class="bookTitle" type="text" placeholder="About Store">
                            <label for="email">Book Image Url</label>
                            <input class="userMail" type="email" placeholder="https://image.url">
                            <label for="townborn">Description</label>
                            <input class="aboutDesc" type="text" placeholder="Description">
                        </form>
                        <button class="inpBtn aboutBtn" type="submit">About info add</button>
                    </div>
                </div>

                <!-- Join US Table -->
                <div class="dash-table" id="join">
                    <h2>Join Us</h2>
                    <table class="join-us-table" id="joinUsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Full Name</th>
                                <th>Email Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Books Table -->
                    <div class="dash-tables" id="books">
                        <h2>Books</h2>
                        <table class="book-table" id="bookTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Image</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Author</th>
                                    <th>Remove</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Contact Us Table -->
                    <div class="dash-tables" id="contact">
                        <h2>Contact Us</h2>
                        <table class="contact-table" id="contactUs">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Full Name</th>
                                    <th>Address</th>
                                    <th>Email Address</th>
                                    <th>Phone Number</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../js/admin.js"></script>
    <script type="module">
        // FireBase Setup------------------------------------------------------
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getDatabase, set, ref, get, child, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        //Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBU0sULZYB6-mZdPwFsWw-teB5STW0xBoc",
            authDomain: "bookstore-44df6.firebaseapp.com",
            databaseURL: "https://bookstore-44df6-default-rtdb.firebaseio.com",
            projectId: "bookstore-44df6",
            storageBucket: "bookstore-44df6.appspot.com",
            messagingSenderId: "520272877168",
            appId: "1:520272877168:web:0245c151c6b0c41c62c6b5",
            measurementId: "G-WKRXPCNFEL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Generate a UUID (version 4)
        function generate_uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Show success alert
        function successAlert(message) {
            const modal = document.getElementById("myModal");
            const modalMessage = document.getElementById("modalMessage");
            modalMessage.textContent = message;
            modal.style.display = "block";
            setTimeout(() => {
                modal.style.display = "none";
            }, 50000);
        }

        // Show error alert
        function errorAlert(message) {
            const modal = document.getElementById("myModal");
            const modalMessage = document.getElementById("modalMessage");
            modalMessage.textContent = message;
            modal.style.display = "block";
            setTimeout(() => {
                modal.style.display = "none";
            }, 50000);
        }

        // Login functionality
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector('.login-form');
            const usernameInput = document.querySelector('input[type="text"]');
            const passwordInput = document.querySelector('input[type="password"]');
            const button = document.querySelector('.adminJoin');
            const login = document.querySelector('.admin-login');
            const dashboard = document.querySelector('.panel');

            button.addEventListener('click', function (event) {
                event.preventDefault();

                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();

                signInWithEmailAndPassword(auth, username, password)
                    .then(() => {
                        login.style.display = 'none';
                        dashboard.style.display = 'block';
                        dashboard.style.display = 'flex';
                    })
                    .catch(() => {
                        alert('Invalid username or password');
                    });
            });

            passwordInput.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    button.click();
                }
            });
        });

        // Add Book functionality
        document.addEventListener("DOMContentLoaded", function () {
            const booknameInp = document.querySelector(".bookName");
            const authorInp = document.querySelector(".authorName");
            const bookDate = document.querySelector(".bookDate");
            const bookimgInp = document.querySelector(".bookImage");
            const descriptInp = document.querySelector(".bookDesc");
            const bookType = document.querySelector(".bookType");
            const addBtn = document.querySelector(".formBtn");
            const bookCat = document.querySelector("#bookCat");
            const bookTable = document.querySelector("#bookTable tbody");

            function truncateDescription(description, wordLimit) {
                const words = description.split(' ');
                if (words.length > wordLimit) {
                    return words.slice(0, wordLimit).join(' ') + '...';
                }
                return description;
            }

            function sendBooks() {
                const id = generate_uuidv4();
                const timestamp = new Date().toISOString();

                set(ref(db, "books/" + id), {
                    name: booknameInp.value,
                    author: authorInp.value,
                    date: bookDate.value,
                    image: bookimgInp.value,
                    description: descriptInp.value,
                    type: bookType.value,
                    id: id,
                    category: bookCat.value,
                    addedAt: timestamp
                })
                    .then(() => {
                        successAlert("Book added successfully");
                        fetchBooks();
                    })
                    .catch((err) => errorAlert("Error adding book: " + err));
            }

            function fetchBooks() {
                const dbRef = ref(db);
                get(child(dbRef, `books/`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const books = snapshot.val();
                        bookTable.innerHTML = "";
                        Object.keys(books).forEach((key, index) => {
                            const book = books[key];
                            const row = bookTable.insertRow();
                            row.insertCell(0).textContent = index + 1;
                            const imgCell = row.insertCell(1);
                            const img = document.createElement("img");
                            img.src = book.image;
                            img.alt = book.name;
                            imgCell.appendChild(img);
                            row.insertCell(2).textContent = book.name;
                            row.insertCell(3).textContent = truncateDescription(book.description, 30);
                            row.insertCell(4).textContent = book.category;
                            row.insertCell(5).textContent = book.author;
                            const removeCell = row.insertCell(6);
                            const removeButton = document.createElement("button");
                            removeButton.textContent = "Remove";
                            removeButton.classList.add("remove-button");
                            removeButton.addEventListener("click", function () {
                                removeBook(book.id);
                            });
                            removeCell.appendChild(removeButton);
                        });
                    } else {
                        bookTable.innerHTML = "<tr><td colspan='7'>No books available</td></tr>";
                    }
                }).catch((error) => {
                    console.error(error);
                });
            }

            function removeBook(id) {
                remove(ref(db, 'books/' + id))
                    .then(() => {
                        successAlert("Book removed successfully");
                        fetchBooks();
                    })
                    .catch((error) => {
                        errorAlert("Error removing book: " + error);
                    });
            }

            addBtn.addEventListener('click', function (event) {
                event.preventDefault();
                sendBooks();
            });

            // Fetch books when the page loads
            fetchBooks();
        });

        // Add About Info 
        document.addEventListener("DOMContentLoaded", function () {
            const titleInp = document.querySelector('.bookTitle');
            const imgInp = document.querySelector('.userMail');
            const descripInp = document.querySelector('.aboutDesc');
            const aboutBtn = document.querySelector('.aboutBtn');

            aboutBtn.addEventListener('click', function () {
                const title = titleInp.value.trim();
                const imgUrl = imgInp.value.trim();
                const description = descripInp.value.trim();

                addAboutInfo(title, imgUrl, description);
            });


            function addAboutInfo(title, imgUrl, description) {
                const id = generate_uuidv4();
                set(ref(db, 'aboutInfo/' + id), {
                    Title: title,
                    Image: imgUrl,
                    Description: description,
                })
                    .then(() => {
                        successAlert('About info added successfully');
                        titleInp.value = '';
                        imgInp.value = '';
                        descripInp.value = '';
                    })
                    .catch((error) => {
                        errorAlert('Error adding about info: ' + error);
                    });
            }
        });


    </script>
</body>

</html>